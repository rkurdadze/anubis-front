<header class="page-header">
  <div class="page-header__title">
    <h1>Управление пользователями и ролями</h1>
    <p class="subtitle">
      Создавайте новых пользователей, распределяйте роли и контролируйте доступ к репозиторию данных.
    </p>
  </div>
  <div class="page-header__actions" *ngIf="!(isFormVisible$ | async)">
    <button type="button" class="btn btn-primary" (click)="startCreateUser()">
      <i class="fa-solid fa-user-plus me-1"></i>
      Новый пользователь
    </button>
  </div>
</header>

<section class="metrics" *ngIf="metrics$ | async as metrics">
  <div class="metric-card">
    <div class="metric-value">{{ metrics.total | number }}</div>
    <div class="metric-label">Всего пользователей</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ metrics.active | number }}</div>
    <div class="metric-label">Активные</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ metrics.inactive | number }}</div>
    <div class="metric-label">Неактивные</div>
  </div>
  <div class="metric-card">
    <div class="metric-value">{{ metrics.locked | number }}</div>
    <div class="metric-label">Заблокированные</div>
  </div>
</section>

<form class="filters" [formGroup]="filtersForm">
  <div class="field">
    <label for="search">Поиск</label>
    <input id="search" type="search" formControlName="search" placeholder="Имя или логин" />
  </div>
  <div class="field">
    <label for="role">Роль</label>
    <select id="role" formControlName="role" class="form-select">
      <option value="all">Все роли</option>
      <option *ngFor="let role of roles$ | async; trackBy: trackRoleById" [ngValue]="role.id">{{ role.name }}</option>
    </select>
  </div>
  <div class="field">
    <label for="group">Группа</label>
    <select id="group" formControlName="group" class="form-select">
      <option value="all">Все группы</option>
      <option *ngFor="let group of groups$ | async; trackBy: trackGroupById" [ngValue]="group.id">{{ group.name }}</option>
    </select>
  </div>
  <div class="field">
    <label for="status">Статус</label>
    <select id="status" formControlName="status" class="form-select">
      <option value="all">Все</option>
      <option value="active">Активен</option>
      <option value="inactive">Неактивен</option>
      <option value="locked">Заблокирован</option>
    </select>
  </div>
  <div class="actions">
    <button type="button" class="link" (click)="resetFilters()">
      <i class="fa-solid fa-rotate-left"></i>
      Сбросить фильтры
    </button>
  </div>
</form>

<section class="user-form panel" *ngIf="formMode$ | async as mode">
  <header class="user-form__header">
    <div>
      <h2>{{ mode === 'create' ? 'Новый пользователь' : 'Редактирование пользователя' }}</h2>
      <p class="section-hint" *ngIf="mode === 'create'">
        Заполните данные, чтобы добавить нового пользователя в систему.
      </p>
      <ng-container *ngIf="mode === 'edit' && (selectedUser$ | async) as editingUser">
        <p class="section-hint">
          Измените параметры для {{ editingUser.fullName || editingUser.username }}.
        </p>
      </ng-container>
    </div>
    <button type="button" class="btn-close" (click)="cancelUserForm()" aria-label="Закрыть форму">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </header>

  <form class="user-form__body" [formGroup]="userForm" (ngSubmit)="onSubmitUserForm()">
    <div class="user-form__grid">
      <label>
        <span>Логин</span>
        <input type="text" formControlName="username" placeholder="user@example.com" />
        <span class="invalid-feedback" *ngIf="userForm.controls.username.touched && userForm.controls.username.invalid">
            Укажите логин пользователя
          </span>
      </label>
      <label>
        <span>Полное имя</span>
        <input type="text" formControlName="fullName" placeholder="Например, Мария Смирнова" />
      </label>
      <label>
        <span>Статус</span>
        <select formControlName="status" class="form-select">
          <option *ngFor="let status of statusOptions" [ngValue]="status.value">{{ status.label }}</option>
        </select>
      </label>
      <label>
        <span>{{ mode === 'edit' ? 'Новый пароль (опционально)' : 'Пароль (опционально)' }}</span>
        <input
          type="text"
          formControlName="password"
          [placeholder]="mode === 'edit' ? 'Оставьте пустым, чтобы не менять' : 'Можно задать позже'"
        />
      </label>
    </div>

    <div class="user-form__lists">
      <section>
        <h3 class="section-title">Группы</h3>
        <p class="section-hint">Отметьте группы, в которых должен состоять пользователь.</p>
        <div class="stacked-list" *ngIf="groups$ | async as groups; else noGroupsList">
          <div class="form-check form-switch" *ngFor="let group of groups; trackBy: trackGroupById">
            <span class="form-check-label">{{ group.name }}</span>
            <input
              #groupToggle
              class="form-check-input"
              type="checkbox"
              [checked]="isIdSelected(userForm.controls.groupIds, group.id)"
              (change)="onToggleId(userForm.controls.groupIds, group.id, groupToggle.checked)"
            />
          </div>
        </div>
      </section>
      <section>
        <h3 class="section-title">Роли</h3>
        <p class="section-hint">Назначьте роли, необходимые пользователю.</p>
        <div class="stacked-list" *ngIf="roles$ | async as roles; else noRolesList">
          <div class="form-check form-switch" *ngFor="let role of roles; trackBy: trackRoleById">
              <span class="form-check-label">
                {{ role.name }}
                <span class="role-desc" *ngIf="role.description">{{ role.description }}</span>
                <span class="role-desc" *ngIf="role.system">Системная роль</span>
              </span>
            <input
              #roleToggle
              class="form-check-input"
              type="checkbox"
              [checked]="isIdSelected(userForm.controls.roleIds, role.id)"
              (change)="onToggleId(userForm.controls.roleIds, role.id, roleToggle.checked)"
            />
          </div>
        </div>
      </section>
    </div>

    <ng-template #noGroupsList>
      <div class="empty-state subtle">
        <i class="fa-solid fa-people-group"></i>
        <p>Группы ещё не созданы.</p>
      </div>
    </ng-template>

    <ng-template #noRolesList>
      <div class="empty-state subtle">
        <i class="fa-solid fa-key"></i>
        <p>Роли ещё не созданы.</p>
      </div>
    </ng-template>

    <div class="user-form__actions">
      <button type="submit" class="primary">
        <i class="fa-solid" [ngClass]="mode === 'create' ? 'fa-user-plus' : 'fa-floppy-disk'"></i>
        {{ mode === 'create' ? 'Создать пользователя' : 'Сохранить изменения' }}
      </button>
      <button type="button" class="secondary" (click)="cancelUserForm()">
        <i class="fa-solid fa-xmark"></i>
        Отмена
      </button>
    </div>
  </form>
</section>

<div class="content-grid">
  <section class="users-list panel">
    <header>
      <h2>Пользователи</h2>
      <p>Выберите пользователя, чтобы просмотреть детали и изменить роли.</p>
    </header>

    <ng-container *ngIf="filteredUsers$ | async as users">
      <ng-container *ngIf="roleNameMap$ | async as roleNameMap">
        <ng-container *ngIf="groupNameMap$ | async as groupNameMap">
          <ng-container *ngIf="selectedUserId$ | async as selectedUserId">
            <div class="table-wrapper" *ngIf="users.length; else emptyUsers">
      <table>
        <thead>
          <tr>
            <th>Имя</th>
            <th>Логин</th>
            <th>Группы</th>
            <th>Роли</th>
            <th>Статус</th>
            <th class="actions-col">Действия</th>
          </tr>
        </thead>
        <tbody>
                  <tr
                    *ngFor="let user of users; trackBy: trackUserById"
                    (click)="selectUser(user)"
                    [class.is-selected]="selectedUserId === user.id"
                  >
                    <td>
                      <span class="user-name">{{ user.fullName || user.username }}</span>
                    </td>
                    <td>{{ user.username }}</td>
                    <td>
                      <ng-container *ngIf="user.groupIds.length; else noGroups">
                        <span class="badge" *ngFor="let groupId of user.groupIds">
                          {{ groupNameMap.get(groupId) ?? '—' }}
                        </span>
                      </ng-container>
                      <ng-template #noGroups><span class="text-muted small">—</span></ng-template>
                    </td>
                    <td>
                      <ng-container *ngIf="user.roleIds.length; else noRoles">
                        <span class="badge" *ngFor="let roleId of user.roleIds">
                          {{ roleNameMap.get(roleId) ?? '—' }}
                        </span>
                      </ng-container>
                      <ng-template #noRoles><span class="text-muted small">—</span></ng-template>
                    </td>
                    <td>
                      <span class="status" [ngClass]="user.status">{{ getStatusLabel(user.status) }}</span>
                    </td>
                    <td class="actions">
                      <div class="table-actions">
                        <button
                          type="button"
                          class="btn btn-outline-warning btn-icon"
                          aria-label="Редактировать пользователя"
                          (click)="startEditUser(user); $event.stopPropagation()"
                        >
                          <i class="fa-solid fa-pen"></i>
                        </button>
                        <button
                          type="button"
                          class="btn btn-outline-danger btn-icon"
                          aria-label="Удалить пользователя"
                          (click)="removeUser(user.id); $event.stopPropagation()"
                        >
                          <i class="fa-solid fa-user-minus"></i>
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </ng-container>
        </ng-container>
      </ng-container>
    </ng-container>

    <ng-template #emptyUsers>
      <div class="empty-state">
        <i class="fa-solid fa-user-group"></i>
        <p>Подходящих пользователей не найдено.</p>
      </div>
    </ng-template>
  </section>

  <section class="user-details panel">
    <ng-container *ngIf="selectedUser$ | async as selectedUser; else noSelection">
      <ng-container *ngIf="groupNameMap$ | async as groupNameMap">
        <ng-container *ngIf="roleNameMap$ | async as roleNameMap">
          <header>
            <div>
              <h2>{{ selectedUser.fullName || selectedUser.username }}</h2>
              <p>{{ selectedUser.username }}</p>
            </div>
            <span class="status" [ngClass]="selectedUser.status">{{ getStatusLabel(selectedUser.status) }}</span>
          </header>

          <dl class="user-meta">
            <div>
              <dt>Количество групп</dt>
              <dd>{{ selectedUser.groupIds.length }}</dd>
            </div>
            <div>
              <dt>Количество ролей</dt>
              <dd>{{ selectedUser.roleIds.length }}</dd>
            </div>
          </dl>

          <section class="details-section">
            <h3 class="section-title">Группы</h3>
            <ng-container *ngIf="selectedUser.groupIds.length; else noUserGroups">
              <div class="tag-list">
                <span class="badge" *ngFor="let groupId of selectedUser.groupIds">
                  {{ groupNameMap.get(groupId) ?? '—' }}
                </span>
              </div>
            </ng-container>
            <ng-template #noUserGroups>
              <p class="text-muted small">Пользователь пока не входит ни в одну группу.</p>
            </ng-template>
          </section>

          <section class="details-section">
            <h3 class="section-title">Роли</h3>
            <ng-container *ngIf="selectedUser.roleIds.length; else noUserRoles">
              <div class="tag-list">
                <span class="badge" *ngFor="let roleId of selectedUser.roleIds">
                  {{ roleNameMap.get(roleId) ?? '—' }}
                </span>
              </div>
            </ng-container>
            <ng-template #noUserRoles>
              <p class="text-muted small">Роли ещё не назначены.</p>
            </ng-template>
          </section>


        </ng-container>
      </ng-container>
    </ng-container>

    <ng-template #noSelection>
      <div class="empty-state">
        <i class="fa-solid fa-user-check"></i>
        <p>Выберите пользователя из списка слева.</p>
      </div>
    </ng-template>
  </section>


</div>
