<section class="container-fluid py-4 classes-page">
  <header class="page-header">
    <div class="page-header__title">
      <h1 class="h3 mb-1">Классы объектов</h1>
      <p class="text-muted mb-0 page-header__description">Настройка бизнес-классов и связанных с ними свойств</p>
    </div>
    <div class="page-header__actions">
      <button class="btn btn-outline-secondary" type="button" (click)="refresh()">
        <i class="fa-solid fa-rotate-right me-1"></i>Обновить список
      </button>
      <button
        type="button"
        class="btn"
        [ngClass]="classPrimaryButtonClasses"
        (click)="handleClassPrimaryAction()"
      >
        <i class="fa-fw" [ngClass]="classPrimaryButtonIcon"></i>
        <span class="ms-2">{{ classPrimaryButtonLabel }}</span>
      </button>
    </div>
  </header>

  <div *ngIf="message$ | async as message" class="alert"
       [ngClass]="message.type === 'success' ? 'alert-success' : 'alert-danger'">
    {{ message.text }}
  </div>

  <div class="row g-4 align-items-start">
    <div class="col-12 col-xl-5">
      <div class="card border-0 anubis-shadow h-100">
        <div class="card-header bg-white">
          <h2 class="h5 mb-0">Список классов</h2>
        </div>
        <div class="card-body border-bottom">
          <form [formGroup]="filterForm" class="row g-3" (ngSubmit)="$event.preventDefault()">
            <div class="col-12">
              <label class="form-label">Поиск</label>
              <input type="search" class="form-control" formControlName="search" placeholder="Название, ID или тип"/>
            </div>
            <div class="col-12">
              <label class="form-label">Тип объекта</label>
              <select class="form-select" formControlName="objectTypeId">
                <option [ngValue]="null">Все типы</option>
                <option *ngFor="let type of objectTypes$ | async" [ngValue]="type.id">{{ type.name }}</option>
              </select>
            </div>
            <div class="col-12">
              <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" id="showInactive" formControlName="showInactive"/>
                <label class="form-check-label" for="showInactive">Показывать деактивированные классы</label>
              </div>
            </div>
          </form>
        </div>
        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead class="table-light text-uppercase small text-muted">
            <tr>
              <th scope="col">Название</th>
              <th scope="col">Тип</th>
              <th scope="col" class="text-end">Действия</th>
            </tr>
            </thead>
            <tbody>
            <tr
              *ngFor="let cls of filteredClasses$ | async; trackBy: trackByClassId"
              [ngClass]="{ 'table-active': (selectedClass$ | async)?.id === cls.id }"
            >
              <td>
                <button class="btn btn-link p-0 fw-semibold" type="button" (click)="selectClass(cls)">
                  {{ cls.name }}
                </button>
                <div class="text-muted small">ID: {{ cls.id }}</div>
              </td>
              <td>#{{ cls.objectTypeId }}</td>
              <td class="text-end">
                <button class="btn btn-outline-danger btn-icon" type="button" (click)="deleteClass(cls)"
                        [disabled]="deletingClassId === cls.id">
                  <i class="fa-solid fa-trash"></i>
                  <span class="visually-hidden">Удалить</span>
                </button>
              </td>
            </tr>
            <tr *ngIf="(filteredClasses$ | async)?.length === 0">
              <td colspan="3" class="text-center text-muted py-4">Классы не найдены.</td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-12 col-xl-7 mt-4 mt-xl-0">
      <ng-container *ngIf="isClassFormOpen; else classFormPlaceholder">
        <div class="section-stack">
          <div class="card border-0 anubis-shadow" [ngClass]="{ 'border-success': classForm.valid }">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <div>
                <h2 class="h5 mb-0">{{ (selectedClass$ | async)?.name ?? 'Новый класс' }}</h2>
                <p class="text-muted small mb-0">
                  {{ (selectedClass$ | async) ? 'Редактирование выбранного класса' : 'Создание нового бизнес-класса' }}
                </p>
              </div>
              <div class="d-flex align-items-center gap-2">
                <span
                  *ngIf="(selectedClass$ | async)?.isActive === false"
                  class="badge bg-secondary-subtle text-secondary"
                >Деактивирован</span
                >
                <button type="button" class="btn btn-outline-secondary" (click)="closeClassForm()">
                  <i class="fa-solid fa-xmark me-1"></i>Скрыть
                </button>
              </div>
            </div>
            <div class="card-body">
              <form [formGroup]="classForm" class="row g-3" (ngSubmit)="saveClass()">
                <div class="col-12">
                  <label class="form-label" for="className">Название</label>
                  <input
                    id="className"
                    type="text"
                    class="form-control"
                    formControlName="name"
                    [class.is-invalid]="classForm.get('name')?.invalid && classForm.get('name')?.touched"
                  />
                  <div class="invalid-feedback">Введите название класса.</div>
                </div>
                <div class="col-12 col-md-6">
                  <label class="form-label" for="classObjectType">Тип объекта</label>
                  <select
                    id="classObjectType"
                    class="form-select"
                    formControlName="objectTypeId"
                    [class.is-invalid]="classForm.get('objectTypeId')?.invalid && classForm.get('objectTypeId')?.touched"
                  >
                    <option [ngValue]="null" disabled>Выберите тип объекта</option>
                    <option *ngFor="let type of objectTypes$ | async" [ngValue]="type.id">{{ type.name }}</option>
                  </select>
                  <div class="invalid-feedback">Укажите тип объекта.</div>
                </div>
                <div class="col-12 col-md-6 d-flex align-items-center">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="classActive" formControlName="isActive"/>
                    <label class="form-check-label" for="classActive">
                      {{ classForm.get('isActive')?.value ? 'Активен' : 'Деактивирован' }}
                    </label>
                  </div>
                </div>
                <div class="col-12">
                  <label class="form-label" for="classDescription">Описание</label>
                  <textarea
                    id="classDescription"
                    class="form-control"
                    rows="3"
                    formControlName="description"
                    placeholder="Назначение класса"
                  ></textarea>
                </div>
                <div class="col-12 d-flex gap-2 flex-wrap">
                  <button type="submit" class="btn btn-success flex-fill"
                          [disabled]="isSavingClass || classForm.invalid">
                    <i class="fa-solid" [ngClass]="(selectedClass$ | async) ? 'fa-floppy-disk' : 'fa-plus'"></i>
                    <span class="ms-2">{{ (selectedClass$ | async) ? 'Сохранить изменения' : 'Создать класс' }}</span>
                  </button>
                  <button type="button" class="btn btn-outline-secondary flex-fill" (click)="startCreate()">
                    <i class="fa-solid fa-eraser"></i>
                    <span class="ms-2">Сбросить</span>
                  </button>
                </div>
              </form>
            </div>
          </div>

          <div class="card border-0 anubis-shadow" *ngIf="(selectedClass$ | async) as current">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
              <div>
                <h2 class="h6 mb-0">Привязанные свойства</h2>
                <p class="text-muted small mb-0">Определяют метаданные доступные для объектов класса</p>
              </div>
            </div>
            <div class="card-body border-bottom">
              <form [formGroup]="bindingForm" class="row g-3" (ngSubmit)="createBinding()">
                <div class="col-12 col-lg-6">
                  <label class="form-label" for="bindingProperty">Свойство</label>
                  <select id="bindingProperty" class="form-select" formControlName="propertyDefId">
                    <option [ngValue]="null" disabled>Выберите свойство</option>
                    <option *ngFor="let prop of properties$ | async" [ngValue]="prop.id">{{ prop.name }}</option>
                  </select>
                </div>
                <div class="col-12 col-lg-2">
                  <label class="form-label" for="bindingOrder">Порядок</label>
                  <input id="bindingOrder" type="number" class="form-control" formControlName="displayOrder"/>
                </div>
                <div class="col-6 col-lg-2 d-flex align-items-center">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="bindingReadonly" formControlName="isReadonly"/>
                    <label class="form-check-label" for="bindingReadonly">Только чтение</label>
                  </div>
                </div>
                <div class="col-6 col-lg-2 d-flex align-items-center">
                  <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="bindingHidden" formControlName="isHidden"/>
                    <label class="form-check-label" for="bindingHidden">Скрыть</label>
                  </div>
                </div>
                <div class="col-12">
                  <button type="submit" class="btn btn-outline-primary"
                          [disabled]="isSavingBinding || bindingForm.invalid">
                    <i class="fa-solid fa-plus"></i>
                    <span class="ms-2">Добавить свойство</span>
                  </button>
                </div>
              </form>
            </div>
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-light text-uppercase small text-muted">
                <tr>
                  <th scope="col">Свойство</th>
                  <th scope="col">Порядок</th>
                  <th scope="col">Флаги</th>
                  <th scope="col" class="text-end">Действия</th>
                </tr>
                </thead>
                <tbody>
                <tr *ngFor="let binding of bindings$ | async; trackBy: trackByBindingId">
                  <td>
                    <div class="fw-semibold">#{{ binding.propertyDefId }}</div>
                    <div class="text-muted small">ID привязки: {{ binding.id }}</div>
                  </td>
                  <td>{{ binding.displayOrder ?? '—' }}</td>
                  <td>
                      <span class="badge rounded-pill"
                            [ngClass]="binding.isReadonly ? 'bg-warning-subtle text-warning' : 'bg-light text-muted'">
                        {{ binding.isReadonly ? 'Только чтение' : 'Редактируемое' }}
                      </span>
                    <span class="badge rounded-pill ms-1"
                          [ngClass]="binding.isHidden ? 'bg-secondary-subtle text-secondary' : 'bg-light text-muted'">
                        {{ binding.isHidden ? 'Скрыто' : 'Видимо' }}
                      </span>
                    <span class="badge rounded-pill ms-1"
                          [ngClass]="binding.isActive ? 'bg-success-subtle text-success' : 'bg-secondary-subtle text-secondary'">
                        {{ binding.isActive ? 'Активно' : 'Выключено' }}
                      </span>
                  </td>
                  <td class="text-end">
                    <div class="btn-group btn-group-sm">
                      <button class="btn btn-outline-secondary" type="button" (click)="deactivateBinding(binding)">
                        <i class="fa-solid fa-ban"></i>
                        <span class="visually-hidden">Деактивировать</span>
                      </button>
                      <button class="btn btn-outline-danger" type="button" (click)="deleteBinding(binding)"
                              [disabled]="deletingBindingId === binding.id">
                        <i class="fa-solid fa-trash"></i>
                        <span class="visually-hidden">Удалить</span>
                      </button>
                    </div>
                  </td>
                </tr>
                <tr *ngIf="(bindings$ | async)?.length === 0">
                  <td colspan="4" class="text-center text-muted py-4">Пока нет привязанных свойств.</td>
                </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </ng-container>
      <ng-template #classFormPlaceholder>
        <div class="card border-0 anubis-shadow placeholder-card">
          <div class="card-body text-center py-5">
            <i class="fa-solid fa-layer-group display-5 text-primary"></i>
            <p class="mt-3 mb-0 text-muted">Нажмите «Новый класс», чтобы открыть форму создания.</p>
          </div>
        </div>
      </ng-template>
    </div>
  </div>
</section>
