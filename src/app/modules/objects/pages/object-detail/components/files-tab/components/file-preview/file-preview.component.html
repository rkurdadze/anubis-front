<div class="card border-0 anubis-shadow h-100 file-preview-card">
  <div class="card-header bg-white d-flex align-items-center justify-content-between flex-wrap gap-2">
    <div class="d-flex align-items-center gap-2">
      <div class="file-icon file-icon--preview" *ngIf="file">
        <i [ngClass]="fileIcon"></i>
      </div>
      <div>
        <h3 class="h6 mb-0">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Ñ–∞–π–ª–∞</h3>
        <div class="text-muted small" *ngIf="file">
          {{ file.filename }}
          <span *ngIf="file.size"> ¬∑ {{ formatSize(file.size) }}</span>
        </div>
      </div>
    </div>
    <div class="d-flex align-items-center gap-2" *ngIf="state.data as data">
      <div class="text-muted small">{{ (data.zoom * 100) | number: '1.0-0' }}%</div>
      <button
        type="button"
        class="btn btn-outline-secondary btn-icon"
        (click)="onZoom(-0.1)"
        [disabled]="loading || saving"
      >
        <i class="fa-solid fa-magnifying-glass-minus"></i>
        <span class="visually-hidden">–£–º–µ–Ω—å—à–∏—Ç—å</span>
      </button>
      <button
        type="button"
        class="btn btn-outline-secondary btn-icon"
        (click)="onZoom(0.1)"
        [disabled]="loading || saving"
      >
        <i class="fa-solid fa-magnifying-glass-plus"></i>
        <span class="visually-hidden">–£–≤–µ–ª–∏—á–∏—Ç—å</span>
      </button>
      <button
        type="button"
        class="btn btn-outline-secondary btn-icon"
        (click)="resetZoom()"
        [disabled]="loading || saving"
      >
        <i class="fa-solid fa-arrows-rotate"></i>
        <span class="visually-hidden">–ü–æ —Ä–∞–∑–º–µ—Ä—É</span>
      </button>
      <button type="button" class="btn btn-outline-secondary btn-icon" (click)="toggleFullscreen()">
        <i class="fa-solid fa-expand"></i>
        <span class="visually-hidden">–ù–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω</span>
      </button>
      <button
        type="button"
        class="btn btn-primary btn-sm"
        (click)="toggleEditing()"
        [disabled]="!data.editable || loading || saving"
      >
        <i class="fa-solid" [ngClass]="state.isEditing ? 'fa-pen-to-square' : 'fa-pen'"></i>
        <span class="ms-1">{{
            state.isEditing ? '–ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ' : '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å'
          }}</span>
      </button>
    </div>
  </div>

  <div class="card-body" #previewWrapper>
    <div *ngIf="loading" class="text-center text-muted py-5">
      <span class="spinner-border text-primary"></span>
      <div class="mt-2">–ó–∞–≥—Ä—É–∂–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ñ–∞–π–ª–∞‚Ä¶</div>
    </div>

    <div *ngIf="!loading && error" class="alert alert-danger mb-0">{{ error }}</div>

    <ng-container *ngIf="!loading && !error">
      <p class="text-muted mb-0" *ngIf="!file">
        –í—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–ª–µ–≤–∞, —á—Ç–æ–±—ã –ø—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ.
      </p>

      <ng-container *ngIf="file && state.data as data">
        <div
          *ngIf="data.pages.length > 1"
          class="preview-nav d-flex flex-wrap align-items-center gap-2 mb-3"
        >
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="onPageChange(data.currentPage - 1)"
            [disabled]="data.currentPage === 0"
          >
            <i class="fa-solid fa-chevron-left"></i>
          </button>
          <div class="d-flex align-items-center gap-2">
            <input
              type="number"
              class="form-control form-control-sm preview-nav__input"
              [ngModel]="data.currentPage + 1"
              (ngModelChange)="onPageInput($event)"
              min="1"
              [max]="data.pages.length"
            />
            <span class="text-muted">/ {{ data.pages.length }}</span>
          </div>
          <button
            type="button"
            class="btn btn-outline-secondary btn-sm"
            (click)="onPageChange(data.currentPage + 1)"
            [disabled]="data.currentPage === data.pages.length - 1"
          >
            <i class="fa-solid fa-chevron-right"></i>
          </button>
          <select
            class="form-select form-select-sm preview-nav__select"
            [ngModel]="data.currentPage"
            (ngModelChange)="onPageChange($event)"
          >
            <option *ngFor="let pageItem of data.pages; let i = index" [ngValue]="i">
              {{ pageItem.label }}
            </option>
          </select>
        </div>

        <div class="preview-stage" #stage>
          <div class="preview-stage__canvas" [ngStyle]="canvasStyle">
            <ng-container [ngSwitch]="data.kind">
              <!-- üñºÔ∏è –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è -->
              <img
                *ngSwitchCase="'image'"
                [src]="imageResourceUrl"
                alt="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è"
                class="preview-stage__image"
              />

<!--              <div *ngSwitchCase="'pdf'" class="preview-stage__pdf">-->
<!--                <pdf-viewer-->
<!--                  *ngIf="pdfViewerSrc"-->
<!--                  [src]="pdfViewerSrc"-->
<!--                  [render-text]="true"-->
<!--                  [original-size]="true"-->
<!--                  [show-all]="true"-->
<!--                  [fit-to-page]="true"-->
<!--                  style="display:block;width:100%;height:100%;">-->
<!--                </pdf-viewer>-->
<!--              </div>-->

              <div *ngSwitchCase="'pdf'" class="preview-stage__pdf">
              <pdf-viewer
                *ngIf="pdfViewerSrc"
                [src]="pdfViewerSrc"
                [render-text]="true"
                [original-size]="true"
                [fit-to-page]="true"
                [show-all]="true"
                (after-load-complete)="onPdfLoaded($event)"
                style="display:block;width:100%;height:100%;">
              </pdf-viewer>
              </div>

            </ng-container>
          </div>
        </div>

        <!-- ‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ -->
        <div *ngIf="state.isEditing && data.editable" class="preview-editor mt-3">
          <app-file-editor
            [kind]="data.kind"
            [pages]="data.pages"
            [currentPage]="data.currentPage"
            [saving]="saving"
            (pageDataChange)="onPageDataChange($event)"
            (pageLabelChange)="onPageLabelChange($event)"
          ></app-file-editor>

          <div class="d-flex justify-content-end gap-2 mt-3">
            <button
              type="button"
              class="btn btn-outline-secondary"
              (click)="onReset()"
              [disabled]="saving"
            >
              <i class="fa-solid fa-rotate-left me-1"></i>
              –°–±—Ä–æ—Å–∏—Ç—å
            </button>
            <button
              type="button"
              class="btn btn-primary"
              (click)="onSave()"
              [disabled]="saving"
            >
              <span *ngIf="saving" class="spinner-border spinner-border-sm me-1"></span>
              <i class="fa-solid fa-floppy-disk me-1"></i>
              –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
            </button>
          </div>
        </div>
      </ng-container>
    </ng-container>
  </div>
</div>
